<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kaizen Voice Recorder</title>
</head>
<body>
  <h2>ğŸ™ï¸ Voice Kaizen</h2>
  <p><em>Say your name and what you're happy about today.</em></p>

  <button id="recordButton">ğŸ”´ Start Recording</button>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const button = document.getElementById("recordButton");
    const status = document.getElementById("status");

    button.addEventListener("click", async () => {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          status.textContent = "â³ Sending...";
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const base64Audio = await toBase64(audioBlob);

          try {
            const response = await fetch("https://u0619ig9dk.execute-api.eu-central-1.amazonaws.com/kaizen", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ audio_base64: base64Audio })
            });

            const result = await response.json();
            status.textContent = "âœ… Sent! Story ID: " + result.id;
          } catch (error) {
            status.textContent = "âŒ Error sending voice story.";
          }

          button.textContent = "ğŸ”´ Start Recording";
          mediaRecorder = null;
        };

        mediaRecorder.start();
        button.textContent = "â¹ï¸ Stop Recording";
        status.textContent = "ğŸ™ï¸ Recording... Tap again to stop.";
      } else if (mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    });

    function toBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
