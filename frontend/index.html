<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kaizen Voice Recorder</title>
</head>
<body>
  <h2>ğŸ™ï¸ Voice Kaizen</h2>
  <p><em>Say your name and what you're happy about today.</em></p>

  <button id="recordButton">ğŸ”´ Start Recording</button>
  <p id="status"></p>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById("recordButton").addEventListener("click", async () => {
      const status = document.getElementById("status");

      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const base64Audio = await toBase64(audioBlob);

          const response = await fetch("https://u0619ig9dk.execute-api.eu-central-1.amazonaws.com/kaizen", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({
              audio_base64: base64Audio
            })
          });

          const result = await response.json();
          status.textContent = "âœ… Sent! Story ID: " + result.id;
          audioChunks = [];
        };

        mediaRecorder.start();
        status.textContent = "ğŸ™ï¸ Recording... Tap again to stop.";
        document.getElementById("recordButton").textContent = "â¹ï¸ Stop Recording";
      } else {
        mediaRecorder.stop();
        document.getElementById("recordButton").textContent = "ğŸ”´ Start Recording";
      }
    });

    function toBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
